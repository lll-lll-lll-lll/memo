# dockerのマウントについて


### コンテナにおけるデータ管理
- 参考: https://matsuand.github.io/docs.docker.jp.onthefly/storage/


#### 概要
- デフォルトではコンテナが存在しなくなるとデータをコンテナに保存しておくことができなくなる。
    - 外部プロセスからコンテナデータを取得することは困難
- コンテナの書き込み可能レイヤーはホストマシンに結び付けられている。なので、中のデータを他に移動することは容易ではない
- コンテナ内のファイルをホスト情報で保存する方法は2つある
    - コンテナを停止した後でもデータを維持することができる
    - **ボリューム*※と**バインドマウント**
- 永続的ではないホストマシンのインメモリに一時的に保存しておくコンテナをサポートしている


#### ボリュームについて
- ホストのファイルシステムの一部としてデータが保存される. これは**Docker**によって管理される
- Dockerによって生成され管理されるもの
- ボリュームを生成すると、Dockerホスト上のディレクトリに保存される。このボリュームをコンテナにマウントすることで、そのディレクトリがコンテナ内にマウントされる
- ボリュームドライバーがサポートされていて、たとえば手元のデータをリモートホストやクラウドプロパイダーに保存できる
- localボリュームを利用する場合は、コンテナ間でデータの共有はされない。一方で、ボリュームドライバーの中にはストレージ共有をサポートするものがある
- Cloudstor プラグインを利用して、AwsやAzureを恒常的なストレージをサポートしている


##### メリット
- バインドマウントよりバックアップと移行が容易
- Docker CLIやDocker APIを利用して管理できる
- 複数コンテナ間で共有可能
- クラウドプロバイダー上のボリュームに保存可能

#### マシン間でのデータの共有
- フォールトトレラントなアプリを構築する場合、1つのサービスに対するレプリカを複数生成して、それらがアクセスするファイルを同一にする設定を行う場合がある
- aws s3に保存するようにアプリにロジックを組み込む
- ボリュームドライバーを使うと、ストレージシステムを抽象化でき、別のドライバーを使いたいケースでもアプリケーションのロジックを変える必要がない


#### バインドマウント
- ホストシステム上のどこにでも保存することができる
- ホストマシン上のファイルやディレクトリがマウントされる
- ホストマシンのos構造に依存する


#### tmfpsマウント
- 一時的にインメモリにデータを保存したいケース



### 具体例
- 初回実行時にボリュームが生成される
- 
```docker-compose 
version: "3.9"
services:
  frontend:
    image: node:lts
    volumes:
      - myapp:/home/node/app
volumes:
  myapp:
```



### ストレージドライバーについて
#### 概要
ストレージドライバーを効率よく利用するには、Dockerがどのようにイメージをビルドし、保存するか、そのイメージをコンテナはどのように利用するのか理解しておくことが重要
これを理解していると、データの適切な保存方法やアプリケーション稼働中のパフォーマンスについて最良の対策を取ることができる

- dockerはストレージドライバーを使用して、イメージをコンテナの書き込み可能レイヤーに保存する。
- ストレージドライバーはスペース効率に最適化されているが、書き込み速度はネイティブファイルシステムより遅い
- データベース・ストレージのような書き込み集中型のアプリは特に既存のデータが読み取り専用層に存在する場合パフォーマンスのオーバーヘッドの影響を受けやすい
- 書き込み集中型、コンテナ削除後にデータを残したい場合はボリュームを使用するのが推奨
- Dockerはストレージドライバーを使用して、イメージとコンテナの内容を管理する
- ストレージドライバーには種類があるが、どれも積み上げ可能なイメージレイヤーであり、コピーオンライト方式を採用している


#### Dockerイメージ
- Dockerfile内の1命令につき1レイヤーで対応している。一番最後を除き全て読み取り専用レイヤー
- コンテナーとレイヤーの違いは最上部に書き込みレイヤーがあるかないの違い
- コンテナに対して書き込まれた情報は書き込みレイヤーに書き込まれる。コンテナが削除されると書き込みレイヤーも削除される
- 複数のコンテナがある場合、個々のコンテナごとに書き込みレイヤーがあり、イメージは固定だが、状態は各コンテナごとに変わる


```dockerfile
# syntax=docker/dockerfile:1
FROM ubuntu:18.04
LABEL org.opencontainers.image.authors="org@example.com"
COPY . /app
RUN make /app
RUN rm -r $HOME/.cache
CMD python /app/app.py
```